<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PlayerOne - Gamer Cred</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="search.js"></script>
  <style>
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .activity-userblock {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .activity-sessions {
      font-size: 0.9em;
      color: #a0a0a0;
    }
    .activity-time {
      font-size: 1.1em;
      font-weight: 600;
    }
    .profile-card {
      text-align: center;
      padding: 0px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .profile-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }
    .profile-info {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    .profile-stats {
      display: flex;
      gap: 16px;
      justify-content: center;
    }
    .side-by-side-cards {
        display: flex;
        flex-wrap: wrap;
        gap: 2.5rem;
        box-sizing: border-box;
        flex: 1 1 0;
        align-items: stretch;
        align-self: stretch;
    }
    .side-by-side-cards .card {
        flex: 1;
        min-width: 300px;
        margin-bottom: 0;
        box-sizing: border-box;
    }
    .loading-spinner {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: #666;
      font-size: 0.9em;
    }
    .loading-spinner i {
      margin-right: 8px;
    }
    .leaderboard-tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .leaderboard-tabs .tab-btn {
      background: #f3f3f3;
      border: none;
      padding: 0.5rem 1.5rem;
      border-radius: 20px 20px 0 0;
      font-weight: 600;
      cursor: pointer;
      color: #444;
      transition: background 0.2s, color 0.2s;
    }
    .leaderboard-tabs .tab-btn.active {
      background: #4f46e5;
      color: #fff;
    }
    .leaderboard-history-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .leaderboard-history-list li {
      background: #24272e;
      border-radius: 12px;
      margin-bottom: 1rem;
      padding: 1rem 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      border-left: 6px solid #6366f1;
      position: relative;
      transition: box-shadow 0.2s;
    }
    .leaderboard-history-list li .placement {
      font-size: 1.3em;
      font-weight: 700;
      margin-right: 0.7em;
      display: inline-block;
      color: #fff;
    }
    .leaderboard-history-list li .placement-icon {
      font-size: 1.2em;
      margin-right: 0.3em;
      vertical-align: middle;
    }
    .leaderboard-history-list li .period {
      color: #6366f1;
      font-weight: 600;
      font-size: 1em;
      margin-bottom: 0.2em;
    }
    .leaderboard-history-list li .credits {
      color: #fff;
      font-size: 0.98em;
      font-weight: 500;
    }
    .leaderboard-history-list li .most-played {
      color: #666;
      font-size: 0.95em;
      margin-top: 0.2em;
    }
    .profile-activity ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .profile-activity li {
      background: #24272e;
      border-radius: 12px;
      margin-bottom: 1rem;
      padding: 1rem 1.5rem;
      display: flex;
      flex-direction: row;
      gap: 1.2rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      border-left: 6px solid #6366f1;
      position: relative;
      transition: box-shadow 0.2s;
    }
    .profile-activity li:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .profile-activity .game-cover-activity {
      width: 60px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      flex-shrink: 0;
    }
    .profile-activity .activity-details {
      display: flex;
      flex-direction: column;
      gap: 0.2em;
      flex: 1;
    }
    .profile-activity .game-name {
      font-weight: 700;
      color: #fff;
      font-size: 1.15em;
      margin-bottom: 0.1em;
    }
    .profile-activity .activity-time {
      color: #6366f1;
      font-weight: 700;
      font-size: 1em;
      margin-bottom: 0.1em;
    }
    .profile-activity .activity-credits {
      color: #fff;
      font-size: 0.98em;
      font-weight: 500;
      margin-bottom: 0.1em;
    }
    .profile-activity .activity-date {
      color: #8a8fa3;
      font-size: 0.92em;
    }
    .profile-activity .activity-stats-group {
      display: flex;
      flex-direction: column;
      gap: 0.1em;
      margin-top: 0.2em;
      margin-top: auto;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-left">
      <a href="index.html" class="site-title nav-home-btn">Gamer Cred</a>
    </div>
    <div class="nav-center">
      <input type="text" class="search-bar" placeholder="Search players, games...">
    </div>
    <div class="nav-right">
      <button class="discord-login"><i class="fab fa-discord"></i> Login with Discord</button>
    </div>
  </nav>
  <main class="profile-main">
    <section class="profile-card card">
      <div class="profile-header">
        <img class="avatar profile-avatar" src="https://randomuser.me/api/portraits/men/1.jpg" alt="PlayerOne">
        <div class="profile-info">
          <h1>PlayerOne</h1>
          <div class="profile-stats">
            <span><i class="fas fa-trophy"></i> 1,800 pts</span>
            <span><i class="fas fa-medal"></i> Rank #1</span>
          </div>
        </div>
      </div>
    </section>
    <section class="most-played card">
      <h2><i class="fas fa-clock"></i> Most Played</h2>
      <div class="most-played-tabs">
        <button class="tab-btn active" data-tab="played-weekly">Weekly</button>
        <button class="tab-btn" data-tab="played-monthly">Monthly</button>
        <button class="tab-btn" data-tab="played-alltime">All-Time</button>
      </div>
      <div class="tab-content active" id="played-weekly">
        <div class="most-played-carousel">
          <div class="activity-carousel">
            <div class="loading-spinner">
              <i class="fas fa-spinner fa-spin"></i> Loading weekly stats...
            </div>
          </div>
        </div>
      </div>
      <div class="tab-content" id="played-monthly">
        <div class="most-played-carousel">
          <div class="activity-carousel">
            <div class="loading-spinner">
              <i class="fas fa-spinner fa-spin"></i> Loading monthly stats...
            </div>
          </div>
        </div>
      </div>
      <div class="tab-content" id="played-alltime">
        <div class="most-played-carousel">
          <div class="activity-carousel">
            <div class="loading-spinner">
              <i class="fas fa-spinner fa-spin"></i> Loading all-time stats...
            </div>
          </div>
        </div>
      </div>
    </section>
    <div class="side-by-side-cards">
      <section class="profile-activity card">
        <h2><i class="fas fa-gamepad"></i> Recent Activity</h2>
        <ul></ul>
      </section>
      <section class="previous-leaderboard-placements card">
        <h2><i class="fas fa-trophy"></i> Previous Leaderboard Placements</h2>
        <div class="leaderboard-tabs">
          <button class="tab-btn active" data-tab="weekly">Weekly</button>
          <button class="tab-btn" data-tab="monthly">Monthly</button>
        </div>
        <div class="tab-content" id="tab-weekly">
          <ul class="leaderboard-history-list weekly">
            <li>Weekly Placement 1</li>
            <li>Weekly Placement 2</li>
          </ul>
        </div>
        <div class="tab-content" id="tab-monthly">
          <ul class="leaderboard-history-list monthly">
            <li>Monthly Placement 1</li>
            <li>Monthly Placement 2</li>
          </ul>
        </div>
      </section>
    </div>
    <a href="index.html" class="back-link">&larr; Back to Home</a>
  </main>
  <footer>
    <p>Inspired by backloggd & letterboxd. Not affiliated with Discord.</p>
  </footer>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
      // Function to get user ID or username from URL
      function getUserIdentifierFromUrl() {
        const params = new URLSearchParams(window.location.search);
        const identifier = params.get('user'); // Get the raw identifier from URL
        return identifier; // Return as is, no conversion needed
      }

      // Function to fetch and display user profile data
      async function fetchUserProfile(userIdentifier, timeframe = 'alltime') {
        if (!userIdentifier) {
          console.error('User identifier not found in URL.');
          document.querySelector('.profile-header h1').textContent = 'User Not Found';
          document.querySelector('.profile-avatar').src = 'https://www.gravatar.com/avatar/?d=mp&s=50'; // Default avatar
          document.querySelector('.profile-stats span:nth-child(1)').textContent = '';
          document.querySelector('.profile-stats span:nth-child(2)').textContent = '';
          // Hide or clear most played section if user not found
          document.querySelector('.most-played .most-played-carousel .activity-carousel').innerHTML = '<p>User not found or has no stats.</p>';
          return;
        }

        try {
          // Include timeframe in the API call
          const response = await fetch(`/api/user-stats/${userIdentifier}?timeframe=${timeframe}`);
          
          if (response.status === 404) {
               console.warn(`User stats not found for ${userIdentifier}. Displaying basic info.`);
               // Display basic Discord info if available, but no stats
              const discordInfoResponse = await fetch(`/api/user-stats/${userIdentifier}`); // Fetch without timeframe for basic info
              if(discordInfoResponse.ok) {
                  const basicInfo = await discordInfoResponse.json();
                  document.querySelector('.profile-header h1').textContent = basicInfo.username;
                  document.querySelector('.profile-avatar').src = basicInfo.avatar_url;
                  document.querySelector('.profile-stats span:nth-child(1)').textContent = '0 pts';
                  document.querySelector('.profile-stats span:nth-child(2)').textContent = 'Rank N/A';
                  document.querySelector('.most-played .most-played-carousel .activity-carousel').innerHTML = '<p>No gaming activity recorded for this timeframe.</p>';
              } else {
                  // Fallback if even basic info fails
                  document.querySelector('.profile-header h1').textContent = 'User Not Found';
                  document.querySelector('.profile-avatar').src = 'https://www.gravatar.com/avatar/?d=mp&s=50'; // Default avatar
                  document.querySelector('.profile-stats span:nth-child(1)').textContent = '';
                  document.querySelector('.profile-stats span:nth-child(2)').textContent = '';
                   document.querySelector('.most-played .most-played-carousel .activity-carousel').innerHTML = '<p>User not found.</p>';
              }
              return; // Exit the function as user stats were not found
          } else if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
          }

          const userData = await response.json();
          console.log('User Data:', userData); // Debugging: Log the fetched user data

          // Update profile header with fetched data
          document.querySelector('.profile-header h1').textContent = userData.username;
          document.querySelector('.profile-avatar').src = userData.avatar_url;
          document.querySelector('.profile-stats span:nth-child(1)').textContent = `${formatNumberWithCommas(userData.total_credits)} pts`;
          document.querySelector('.profile-stats span:nth-child(2)').textContent = userData.rank !== null ? `Rank #${userData.rank}` : 'Rank N/A';

          // Update Most Played section
          const mostPlayedCarousel = document.querySelector('#played-' + timeframe + ' .activity-carousel');
           if (!mostPlayedCarousel) {
              console.error(`Most played carousel element not found for timeframe: ${timeframe}`);
                  return;
              }
          mostPlayedCarousel.innerHTML = ''; // Clear previous content

          const mostPlayedData = userData.most_played; // This is now a list of games
          console.log('Most played data:', mostPlayedData); // Debug log
          if (mostPlayedData && mostPlayedData.length > 0) {
               mostPlayedData.forEach(game => {
                   console.log('Processing game:', game); // Debug log
                   const hoursPlayed = game.total_hours;
                   const timePlayedDisplay = hoursPlayed >= 1 ? `${hoursPlayed.toFixed(1)} hrs` : `${(hoursPlayed * 60).toFixed(0)} mins`;

                  const cardHtml = `
                      <div class="activity-card-wrap">
                          <div class="activity-card">
                               <a href="game.html?game=${encodeURIComponent(game.game_name)}">
                                  <img class="game-cover-carousel" src="${game.box_art_url || 'https://static-cdn.jtvnw.net/ttv-boxart/loading_boxart.png'}" alt="${game.game_name}">
                              </a>
                              <div class="activity-overlay">
                                  <div class="activity-userblock">
                                       <span class="activity-sessions">${game.game_name}</span>
                                      <span class="activity-time">${timePlayedDisplay}</span>
                                  </div>
                              </div>
                          </div>
                      </div>
                  `;
                  mostPlayedCarousel.innerHTML += cardHtml; // Append each card
               });
          } else {
               mostPlayedCarousel.innerHTML = '<p>No gaming activity recorded for this timeframe.</p>';
          }

          } catch (error) {
          console.error('Error fetching user profile data:', error);
          // Display an error message on the page
          document.querySelector('.profile-header h1').textContent = 'Error loading profile';
          document.querySelector('.profile-avatar').src = 'https://www.gravatar.com/avatar/?d=mp&s=50'; // Default avatar
          document.querySelector('.profile-stats span:nth-child(1)').textContent = '';
          document.querySelector('.profile-stats span:nth-child(2)').textContent = '';
          document.querySelector('.most-played .most-played-carousel .activity-carousel').innerHTML = '<p>Error loading profile data.</p>';
        }
      }

      // Function to handle tab switching
      function handleTabSwitching() {
          // Handle most played tabs
          const mostPlayedTabButtons = document.querySelectorAll('.most-played-tabs .tab-btn');
          const mostPlayedTabContents = document.querySelectorAll('.most-played .tab-content');

          mostPlayedTabButtons.forEach(button => {
              button.addEventListener('click', () => {
                  const targetTabId = button.dataset.tab;
                  const targetContent = document.getElementById(targetTabId);

                  if (!targetContent) {
                      console.error(`Tab content with ID ${targetTabId} not found.`);
                      return;
                  }

                  // Remove active class from all buttons and contents
                  mostPlayedTabButtons.forEach(btn => btn.classList.remove('active'));
                  mostPlayedTabContents.forEach(content => content.classList.remove('active'));

                  // Add active class to the clicked button and target content
                  button.classList.add('active');
                  targetContent.classList.add('active');
              });
          });
      }

      // Call fetchUserProfile when the page loads with the default timeframe (alltime)
      const initialUserIdentifier = getUserIdentifierFromUrl();
      // Fetch data for all timeframes when page loads
      fetchUserProfile(initialUserIdentifier, 'weekly');
      fetchUserProfile(initialUserIdentifier, 'monthly');
      fetchUserProfile(initialUserIdentifier, 'alltime');

      // Function to show/hide loading state
      function setLoadingState(element, isLoading) {
          if (isLoading) {
              element.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
          }
      }

      // Function to fetch and display recent activity
      async function fetchRecentActivity(userIdentifier) {
          console.log(`DEBUG: fetchRecentActivity called for user: ${userIdentifier}`); // Debug print
          const activityList = document.querySelector('.profile-activity ul');
          if (!activityList) {
              console.error('Recent activity list element not found.');
              return;
          }

          setLoadingState(activityList, true);
          
          try {
              console.log('Fetching recent activity for user:', userIdentifier);
              const response = await fetch(`/api/user-stats/${userIdentifier}/history`);
              if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
              }
              const activityData = await response.json();
              console.log('Received activity data:', activityData); // Debug print received data

              activityList.innerHTML = ''; // Clear loading state

              if (!activityData || activityData.length === 0) {
                  activityList.innerHTML = '<li>No recent activity found.</li>';
                  return;
              }

              // Show first 5 items
              const initialItems = activityData.slice(0, 5);
              const remainingItems = activityData.slice(5);

              // Create list items for initial activities
              initialItems.forEach(activity => {
                  const hours = activity.hours;
                  const timeDisplay = hours >= 1 ? `${hours.toFixed(1)}h` : `${(hours * 60).toFixed(0)}m`;
                  const date = new Date(activity.timestamp).toLocaleDateString();
                  
                  const listItem = document.createElement('li');
                  listItem.innerHTML = `
                    <img class="game-cover-activity" src="${activity.box_art_url || 'https://static-cdn.jtvnw.net/ttv-boxart/loading_boxart.png'}" alt="${activity.game_name}" onerror="this.src='https://static-cdn.jtvnw.net/ttv-boxart/loading_boxart.png'">
                    <div class="activity-details">
                      <div class="game-name">
                        <a href="game.html?game=${encodeURIComponent(activity.game_name)}" style="color: #fff; text-decoration: none;">${activity.game_name}</a>
                      </div>
                      <div class="activity-stats-group">
                        <div class="activity-time">${timeDisplay}</div>
                        <div class="activity-credits">${formatNumberWithCommas(activity.credits_earned)} credits earned</div>
                        <div class="activity-date">${date}</div>
                      </div>
                    </div>
                  `;
                  activityList.appendChild(listItem);
              });

              // If there are remaining items, create buttons
              if (remainingItems.length > 0) {
                  const buttonContainer = document.createElement('div');
                  buttonContainer.className = 'button-container';
                  buttonContainer.style.display = 'flex';
                  buttonContainer.style.gap = '1rem';
                  buttonContainer.style.justifyContent = 'center';
                  buttonContainer.style.marginTop = '1rem';

                  // Store the current index in a data attribute
                  buttonContainer.dataset.currentIndex = '5';

                  const moreButton = document.createElement('button');
                  moreButton.className = 'more-button';
                  moreButton.textContent = 'Show More';
                  moreButton.onclick = () => {
                      const currentIndex = parseInt(buttonContainer.dataset.currentIndex);
                      const nextItems = activityData.slice(currentIndex, currentIndex + 5);
                      
                      nextItems.forEach(activity => {
                          const hours = activity.hours;
                          const timeDisplay = hours >= 1 ? `${hours.toFixed(1)}h` : `${(hours * 60).toFixed(0)}m`;
                          const date = new Date(activity.timestamp).toLocaleDateString();
                          
                          const listItem = document.createElement('li');
                          listItem.innerHTML = `
                            <img class="game-cover-activity" src="${activity.box_art_url || 'https://static-cdn.jtvnw.net/ttv-boxart/loading_boxart.png'}" alt="${activity.game_name}" onerror="this.src='https://static-cdn.jtvnw.net/ttv-boxart/loading_boxart.png'">
                            <div class="activity-details">
                              <div class="game-name">
                                <a href="game.html?game=${encodeURIComponent(activity.game_name)}" style="color: #fff; text-decoration: none;">${activity.game_name}</a>
                              </div>
                              <div class="activity-stats-group">
                                <div class="activity-time">${timeDisplay}</div>
                                <div class="activity-credits">${formatNumberWithCommas(activity.credits_earned)} credits earned</div>
                                <div class="activity-date">${date}</div>
                              </div>
                            </div>
                          `;
                          activityList.insertBefore(listItem, buttonContainer);
                      });

                      // Update the current index
                      buttonContainer.dataset.currentIndex = currentIndex + 5;

                      // Hide the buttons if we've shown all items
                      if (currentIndex + 5 >= activityData.length) {
                          buttonContainer.style.display = 'none';
                      }
                  };

                  const showAllButton = document.createElement('button');
                  showAllButton.className = 'more-button';
                  showAllButton.textContent = 'Show All';
                  showAllButton.onclick = () => {
                      const currentIndex = parseInt(buttonContainer.dataset.currentIndex);
                      const remainingItems = activityData.slice(currentIndex);
                      
                      remainingItems.forEach(activity => {
                          const hours = activity.hours;
                          const timeDisplay = hours >= 1 ? `${hours.toFixed(1)}h` : `${(hours * 60).toFixed(0)}m`;
                          const date = new Date(activity.timestamp).toLocaleDateString();
                          
                          const listItem = document.createElement('li');
                          listItem.innerHTML = `
                            <img class="game-cover-activity" src="${activity.box_art_url || 'https://static-cdn.jtvnw.net/ttv-boxart/loading_boxart.png'}" alt="${activity.game_name}" onerror="this.src='https://static-cdn.jtvnw.net/ttv-boxart/loading_boxart.png'">
                            <div class="activity-details">
                              <div class="game-name">
                                <a href="game.html?game=${encodeURIComponent(activity.game_name)}" style="color: #fff; text-decoration: none;">${activity.game_name}</a>
                              </div>
                              <div class="activity-stats-group">
                                <div class="activity-time">${timeDisplay}</div>
                                <div class="activity-credits">${formatNumberWithCommas(activity.credits_earned)} credits earned</div>
                                <div class="activity-date">${date}</div>
                              </div>
                            </div>
                          `;
                          activityList.insertBefore(listItem, buttonContainer);
                      });

                      // Hide the buttons after showing all items
                      buttonContainer.style.display = 'none';
                  };

                  buttonContainer.appendChild(moreButton);
                  buttonContainer.appendChild(showAllButton);
                  activityList.appendChild(buttonContainer);
              }
          } catch (error) {
              console.error('Error fetching recent activity:', error);
              activityList.innerHTML = '<li>Error loading recent activity.</li>';
          }
      }

      // Function to fetch and display leaderboard history
      async function fetchLeaderboardHistory(userIdentifier, type = 'weekly') {
        try {
          const response = await fetch(`/api/user-stats/${userIdentifier}/leaderboard-history?type=${type}`);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const history = await response.json();
          console.log('Leaderboard history:', history); // Debug log

          const historyList = document.querySelector(`.leaderboard-history-list.${type}`);
          if (!historyList) {
            console.error(`History list element not found for type: ${type}`);
            return;
          }

          historyList.innerHTML = ''; // Clear previous content

          if (history.length === 0) {
            historyList.innerHTML = '<li>No leaderboard history available.</li>';
            return;
          }

          // Show first 5 items
          const initialItems = history.slice(0, 5);
          const remainingItems = history.slice(5);

          // Create list items for initial history entries
          initialItems.forEach(entry => {
            console.log('Processing entry:', entry); // Debug log
            const startDate = entry.start_date ? new Date(entry.start_date) : null;
            const endDate = entry.end_date ? new Date(entry.end_date) : null;
            
            const periodDisplay = startDate && endDate 
              ? `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`
              : 'Period not available';

            const placement = entry.placement;
            let placementDisplay = `${placement}${getOrdinalSuffix(placement)}`;
            
            // Only add medal emoji for top 3 placements
            if (placement === 1) {
              placementDisplay = `ðŸ¥‡ ${placementDisplay}`;
            } else if (placement === 2) {
              placementDisplay = `ðŸ¥ˆ ${placementDisplay}`;
            } else if (placement === 3) {
              placementDisplay = `ðŸ¥‰ ${placementDisplay}`;
            }

            const li = document.createElement('li');
            li.innerHTML = `
              <div class="period">${periodDisplay}</div>
              <div>
                <span class="placement">${placementDisplay}</span>
              </div>
              <div class="credits">${formatNumberWithCommas(entry.credits)} credits earned</div>
              <div class="most-played">Most played: ${entry.most_played_game} (${entry.most_played_hours.toFixed(1)}h)</div>
            `;
            historyList.appendChild(li);
          });

          // If there are remaining items, create a hidden container and buttons
          if (remainingItems.length > 0) {
              const hiddenContainer = document.createElement('div');
              hiddenContainer.className = 'hidden-content';
              
              // Store remaining items in a data attribute
              hiddenContainer.dataset.remainingItems = JSON.stringify(remainingItems);
              hiddenContainer.dataset.currentIndex = 0;

              // Create button container
              const buttonContainer = document.createElement('div');
              buttonContainer.className = 'button-container';

              const moreButton = document.createElement('button');
              moreButton.className = 'more-button';
              moreButton.textContent = 'Show More';
              moreButton.onclick = () => {
                  const items = JSON.parse(hiddenContainer.dataset.remainingItems);
                  const currentIndex = parseInt(hiddenContainer.dataset.currentIndex);
                  const nextItems = items.slice(currentIndex, currentIndex + 5);
                  
                  nextItems.forEach(entry => {
                      const startDate = entry.start_date ? new Date(entry.start_date) : null;
                      const endDate = entry.end_date ? new Date(entry.end_date) : null;
                      
                      const periodDisplay = startDate && endDate 
                        ? `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`
                        : 'Period not available';

                      const placement = entry.placement;
                      let placementDisplay = `${placement}${getOrdinalSuffix(placement)}`;
                      
                      if (placement === 1) {
                        placementDisplay = `ðŸ¥‡ ${placementDisplay}`;
                      } else if (placement === 2) {
                        placementDisplay = `ðŸ¥ˆ ${placementDisplay}`;
                      } else if (placement === 3) {
                        placementDisplay = `ðŸ¥‰ ${placementDisplay}`;
                      }

                      const li = document.createElement('li');
                      li.innerHTML = `
                        <div class="period">${periodDisplay}</div>
                        <div>
                          <span class="placement">${placementDisplay}</span>
                        </div>
                        <div class="credits">${formatNumberWithCommas(entry.credits)} credits earned</div>
                        <div class="most-played">Most played: ${entry.most_played_game} (${entry.most_played_hours.toFixed(1)}h)</div>
                      `;
                      
                      historyList.insertBefore(li, buttonContainer);
                  });

                  // Update the current index
                  hiddenContainer.dataset.currentIndex = currentIndex + 5;

                  // Hide the buttons if we've shown all items
                  if (currentIndex + 5 >= items.length) {
                      buttonContainer.style.display = 'none';
                  }
              };

              const showAllButton = document.createElement('button');
              showAllButton.className = 'more-button';
              showAllButton.textContent = 'Show All';
              showAllButton.onclick = () => {
                  const items = JSON.parse(hiddenContainer.dataset.remainingItems);
                  const currentIndex = parseInt(hiddenContainer.dataset.currentIndex);
                  const remainingItems = items.slice(currentIndex);
                  
                  remainingItems.forEach(entry => {
                      const startDate = entry.start_date ? new Date(entry.start_date) : null;
                      const endDate = entry.end_date ? new Date(entry.end_date) : null;
                      
                      const periodDisplay = startDate && endDate 
                        ? `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`
                        : 'Period not available';

                      const placement = entry.placement;
                      let placementDisplay = `${placement}${getOrdinalSuffix(placement)}`;
                      
                      if (placement === 1) {
                        placementDisplay = `ðŸ¥‡ ${placementDisplay}`;
                      } else if (placement === 2) {
                        placementDisplay = `ðŸ¥ˆ ${placementDisplay}`;
                      } else if (placement === 3) {
                        placementDisplay = `ðŸ¥‰ ${placementDisplay}`;
                      }

                      const li = document.createElement('li');
                      li.innerHTML = `
                        <div class="period">${periodDisplay}</div>
                        <div>
                          <span class="placement">${placementDisplay}</span>
                        </div>
                        <div class="credits">${formatNumberWithCommas(entry.credits)} credits earned</div>
                        <div class="most-played">Most played: ${entry.most_played_game} (${entry.most_played_hours.toFixed(1)}h)</div>
                      `;
                      
                      historyList.insertBefore(li, buttonContainer);
                  });

                  // Hide the buttons after showing all items
                  buttonContainer.style.display = 'none';
              };

              buttonContainer.appendChild(moreButton);
              buttonContainer.appendChild(showAllButton);
              historyList.appendChild(buttonContainer);
          }
        } catch (error) {
          console.error('Error fetching leaderboard history:', error);
          const historyList = document.querySelector(`.leaderboard-history-list.${type}`);
          if (historyList) {
            historyList.innerHTML = '<li>Error loading leaderboard history.</li>';
          }
        }
      }

      function getOrdinalSuffix(num) {
        const j = num % 10;
        const k = num % 100;
        if (j == 1 && k != 11) return 'st';
        if (j == 2 && k != 12) return 'nd';
        if (j == 3 && k != 13) return 'rd';
        return 'th';
      }

      // Initial calls to fetch data when the page loads
      const userIdentifier = getUserIdentifierFromUrl();
      if (userIdentifier) {
          fetchUserProfile(userIdentifier, 'alltime');
          fetchRecentActivity(userIdentifier);
          fetchLeaderboardHistory(userIdentifier, 'weekly');
          fetchLeaderboardHistory(userIdentifier, 'monthly');
      }

      // Initialize tab switching logic
      handleTabSwitching();

      // Helper function to format numbers with commas
      function formatNumberWithCommas(number) {
        if (typeof number === 'number') {
          return number.toLocaleString();
        }
        if (!isNaN(Number(number))) {
          return Number(number).toLocaleString();
        }
        return number;
      }

       // Helper function to format hours for display
      function formatHours(hours) {
         const wholeHours = Math.floor(hours);
         const minutes = Math.round((hours - wholeHours) * 60);
         let timeDisplay = '';
         if (wholeHours > 0) {
           timeDisplay += `${wholeHours}h `;
         }
         if (minutes > 0 || wholeHours === 0) { // Show minutes if there are any, or if hours are 0
           timeDisplay += `${minutes}m`;
         }
         return timeDisplay.trim();
      }

      // Placeholder for formatTimeAgo - implement if needed
      function formatTimeAgo(timestamp) {
         const date = new Date(timestamp);
         const now = new Date();
         const diffInSeconds = Math.floor((now - date) / 1000);
         
         if (diffInSeconds < 60) return 'just now';
         if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
         if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
         if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)}d ago`;
         return date.toLocaleDateString();
      }

       // Helper function to capitalize words (if needed elsewhere)
       function capitalizeWords(str) {
         if (!str) return '';
         return str.replace(/\b\w/g, char => char.toUpperCase());
      }

      function setupLeaderboardTabs() {
        const tabContainer = document.querySelector('.leaderboard-tabs');
        if (!tabContainer) return;
        const tabButtons = tabContainer.querySelectorAll('.tab-btn');
        tabButtons.forEach(button => {
          button.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');
            tabContainer.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            const parentSection = this.closest('section');
            parentSection.querySelectorAll('.tab-content').forEach(content => {
              content.style.display = 'none';
            });
            const tabContent = document.getElementById('tab-' + tabId);
            if (tabContent) tabContent.style.display = 'block';
          });
      });
        // Initial display: show the active tab's content
        const initialActive = tabContainer.querySelector('.tab-btn.active');
        if (initialActive) {
          const tabId = initialActive.getAttribute('data-tab');
          const tabContent = document.getElementById('tab-' + tabId);
          if (tabContent) tabContent.style.display = 'block';
        }
        // Hide all other tab contents
        tabButtons.forEach(btn => {
          if (!btn.classList.contains('active')) {
            const tabId = btn.getAttribute('data-tab');
            const tabContent = document.getElementById('tab-' + tabId);
            if (tabContent) tabContent.style.display = 'none';
          }
        });
      }

      function getPlacementIcon(placement) {
        if (placement === 1) return 'ðŸ¥‡';
        if (placement === 2) return 'ðŸ¥ˆ';
        if (placement === 3) return 'ðŸ¥‰';
        return '';
      }

      function fetchWeeklyLeaderboardHistory(userId) {
        fetch(`/api/user-stats/${userId}/leaderboard-history?type=weekly`)
          .then(res => res.json())
          .then(data => {
            const list = document.querySelector('.leaderboard-history-list.weekly');
            if (!data || data.length === 0) {
              list.innerHTML = '<li>No weekly placements found.</li>';
              return;
            }
            list.innerHTML = data.slice(0, 5).map(entry => {
              let placementDisplay = '';
              if (entry.placement === 1 || entry.placement === 2 || entry.placement === 3) {
                placementDisplay = `${entry.placement}${ordinalSuffix(entry.placement)} ${getPlacementIcon(entry.placement)}`;
                      } else {
                placementDisplay = `${entry.placement}${ordinalSuffix(entry.placement)}`;
              }
              return `
                <li>
                  <span class="placement">${placementDisplay}</span>
                  <span class="period">${formatPeriod(entry.period_start, entry.period_end)}</span>
                  <span class="credits">${formatNumberWithCommas(entry.credits)} credits</span>
                  <span class="most-played">Most played: <b>${entry.most_played_game}</b> (${formatNumberWithCommas(entry.most_played_hours)}h)</span>
                </li>
              `;
            }).join('');
          })
          .catch(() => {
            document.querySelector('.leaderboard-history-list.weekly').innerHTML = '<li>Error loading weekly placements.</li>';
          });
      }

      function fetchMonthlyLeaderboardHistory(userId) {
        fetch(`/api/user-stats/${userId}/leaderboard-history?type=monthly`)
          .then(res => res.json())
              .then(data => {
            const list = document.querySelector('.leaderboard-history-list.monthly');
            if (!data || data.length === 0) {
              list.innerHTML = '<li>No monthly placements found.</li>';
              return;
            }
            list.innerHTML = data.slice(0, 5).map(entry => {
              let placementDisplay = '';
              if (entry.placement === 1 || entry.placement === 2 || entry.placement === 3) {
                placementDisplay = `${entry.placement}${ordinalSuffix(entry.placement)} ${getPlacementIcon(entry.placement)}`;
              } else {
                placementDisplay = `${entry.placement}${ordinalSuffix(entry.placement)}`;
              }
              return `
                <li>
                  <span class="placement">${placementDisplay}</span>
                  <span class="period">${formatPeriod(entry.period_start, entry.period_end)}</span>
                  <span class="credits">${formatNumberWithCommas(entry.credits)} credits</span>
                  <span class="most-played">Most played: <b>${entry.most_played_game}</b> (${formatNumberWithCommas(entry.most_played_hours)}h)</span>
                </li>
              `;
            }).join('');
          })
          .catch(() => {
            document.querySelector('.leaderboard-history-list.monthly').innerHTML = '<li>Error loading monthly placements.</li>';
          });
      }

      function ordinalSuffix(n) {
        if (n % 100 >= 11 && n % 100 <= 13) return 'th';
        switch (n % 10) {
          case 1: return 'st';
          case 2: return 'nd';
          case 3: return 'rd';
          default: return 'th';
        }
      }

      function formatPeriod(start, end) {
        const startDate = new Date(start);
        const endDate = new Date(end);
        return `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;
      }

      // Function to load most played games
      function loadMostPlayedGames(period) {
        const userId = getUserIdentifierFromUrl();
        const carousel = document.querySelector(`#played-${period} .activity-carousel`);
        const spinner = carousel.querySelector('.loading-spinner');
        
        fetch(`/api/user/${userId}/most-played?period=${period}`)
          .then(res => res.json())
          .then(games => {
            if (spinner) spinner.remove();
            
            games.forEach(game => {
              const cardWrap = document.createElement('div');
              cardWrap.className = 'activity-card-wrap';
              cardWrap.innerHTML = `
                <div class="activity-card">
                  <a href="game.html?game=${encodeURIComponent(game.name)}">
                    <img class="game-cover-carousel" src="${game.box_art_url || 'https://static-cdn.jtvnw.net/ttv-boxart/loading_boxart.png'}" alt="${game.name}">
                  </a>
                  <div class="activity-overlay">
                    <div class="activity-userblock">
                      <span class="activity-sessions">${game.sessions} sessions</span>
                      <span class="activity-time">${game.hours} hrs</span>
                    </div>
                  </div>
                </div>
              `;
              carousel.appendChild(cardWrap);
            });
          })
          .catch(error => {
            console.error(`Error loading ${period} games:`, error);
            if (spinner) {
              spinner.innerHTML = `<i class="fas fa-exclamation-circle"></i> Error loading ${period} stats`;
            }
          });
      }

      // Load games for each period
      loadMostPlayedGames('weekly');
      loadMostPlayedGames('monthly');
      loadMostPlayedGames('alltime');

      // Tab switching logic
      document.querySelectorAll('.most-played-tabs .tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.most-played-tabs .tab-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          document.querySelectorAll('.most-played .tab-content').forEach(tc => tc.classList.remove('active'));
          const tab = this.getAttribute('data-tab');
          document.getElementById(tab).classList.add('active');
        });
      });

    });

    // Dedicated tab logic for user page leaderboard placements
    (function() {
      const tabContainer = document.querySelector('.previous-leaderboard-placements .leaderboard-tabs');
      if (!tabContainer) return;
      const tabButtons = tabContainer.querySelectorAll('.tab-btn');
      tabButtons.forEach(button => {
        button.addEventListener('click', function() {
          const tabId = this.getAttribute('data-tab');
          tabContainer.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
          this.classList.add('active');
          const parentSection = this.closest('.previous-leaderboard-placements');
          parentSection.querySelectorAll('.tab-content').forEach(content => {
            content.style.display = 'none';
          });
          const tabContent = parentSection.querySelector('#tab-' + tabId);
          if (tabContent) tabContent.style.display = 'block';
        });
      });
      // Initial display: show the active tab's content
      const initialActive = tabContainer.querySelector('.tab-btn.active');
      if (initialActive) {
        const tabId = initialActive.getAttribute('data-tab');
        const tabContent = document.getElementById('tab-' + tabId);
        if (tabContent) tabContent.style.display = 'block';
      }
      // Hide all other tab contents
      tabButtons.forEach(btn => {
        if (!btn.classList.contains('active')) {
          const tabId = btn.getAttribute('data-tab');
          const tabContent = document.getElementById('tab-' + tabId);
          if (tabContent) tabContent.style.display = 'none';
        }
      });
    })();
  </script>
</body>
</html> 