<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=0.4, maximum-scale=1.0, user-scalable=yes">
  <title>Gamer Cred Companion</title>
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    .loading-spinner {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: #666;
      font-size: 0.9em;
    }
    .loading-spinner i {
      margin-right: 8px;
    }
    .loading-placeholder {
      display: flex;
      align-items: center;
      padding: 10px;
      color: #666;
      font-size: 0.9em;
      border-bottom: 1px solid #eee;
    }
    .loading-placeholder i {
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-left">
      <button class="mobile-menu-toggle mobile-only" aria-label="Toggle menu">
        <i class="fas fa-bars"></i>
      </button>
      <a href="/" class="site-title nav-home-btn">
        <img src="/favicon.png" alt="Gamer Cred" class="nav-favicon">
        Gamer Cred
      </a>
    </div>
    <div class="nav-center">
      <input type="text" class="search-bar" placeholder="Search players, games...">
      <a href="/all_games.html" class="nav-link desktop-only">All Games</a>
    </div>
    <div class="nav-right">
      <div id="auth-container">
        <a href="/login" class="auth-button login-button">
          <i class="fab fa-discord"></i>
          Login with Discord
        </a>
      </div>
    </div>
  </nav>
  <main class="main-grid">
    <section class="leaderboard card leaderboard-modern">
      <h2><i class="fas fa-trophy"></i> Leaderboard</h2>
      <div class="leaderboard-tabs">
        <button class="tab-btn active" data-tab="weekly">Weekly</button>
        <button class="tab-btn" data-tab="monthly">Monthly</button>
        <button class="tab-btn" data-tab="alltime">All-Time</button>
      </div>
      <div class="tab-content" id="weekly">
        <ol>
          <li><span class="rank">1</span> <img class="avatar" src="https://randomuser.me/api/portraits/men/1.jpg" alt="PlayerOne"> <a class="user-link" href="user.html?user=170327552525729792">PlayerOne</a> <span class="score">400 pts</span></li>
          <li><span class="rank">2</span> <img class="avatar" src="https://randomuser.me/api/portraits/men/2.jpg" alt="PlayerTwo"> <a class="user-link" href="user.html?user=170327552525729793">PlayerTwo</a> <span class="score">390 pts</span></li>
          <li><span class="rank">3</span> <img class="avatar" src="https://randomuser.me/api/portraits/men/3.jpg" alt="PlayerThree"> <a class="user-link" href="user.html?user=170327552525729794">PlayerThree</a> <span class="score">370 pts</span></li>
          <li><span class="rank">4</span> <img class="avatar" src="https://randomuser.me/api/portraits/men/4.jpg" alt="PlayerFour"> <a class="user-link" href="user.html?user=170327552525729795">PlayerFour</a> <span class="score">350 pts</span></li>
          <li><span class="rank">5</span> <img class="avatar" src="https://randomuser.me/api/portraits/men/5.jpg" alt="PlayerFive"> <a class="user-link" href="user.html?user=170327552525729796">PlayerFive</a> <span class="score">340 pts</span></li>
        </ol>
      </div>
      <div class="tab-content" id="monthly" style="display:none;">
        <ol>
          <li><span class="rank">1</span> <img class="avatar" src="https://randomuser.me/api/portraits/men/1.jpg" alt="PlayerOne"> <a class="user-link" href="user.html?user=170327552525729792">PlayerOne</a> <span class="score">1,800 pts</span></li>
          <li><span class="rank">2</span> <img class="avatar" src="https://randomuser.me/api/portraits/men/2.jpg" alt="PlayerTwo"> <a class="user-link" href="user.html?user=170327552525729793">PlayerTwo</a> <span class="score">1,700 pts</span></li>
          <li><span class="rank">3</span> <img class="avatar" src="https://randomuser.me/api/portraits/men/3.jpg" alt="PlayerThree"> <a class="user-link" href="user.html?user=170327552525729794">PlayerThree</a> <span class="score">1,600 pts</span></li>
          <li><span class="rank">4</span> <img class="avatar" src="https://randomuser.me/api/portraits/men/4.jpg" alt="PlayerFour"> <a class="user-link" href="user.html?user=170327552525729795">PlayerFour</a> <span class="score">1,550 pts</span></li>
          <li><span class="rank">5</span> <img class="avatar" src="https://randomuser.me/api/portraits/men/5.jpg" alt="PlayerFive"> <a class="user-link" href="user.html?user=170327552525729796">PlayerFive</a> <span class="score">1,500 pts</span></li>
        </ol>
      </div>
      <div class="tab-content" id="alltime" style="display:none;">
        <ol>
          <li><span class="rank">1</span> <img class="avatar" src="https://randomuser.me/api/portraits/men/1.jpg" alt="PlayerOne"> <a class="user-link" href="user.html?user=170327552525729792">PlayerOne</a> <span class="score">9,000 pts</span></li>
          <li><span class="rank">2</span> <img class="avatar" src="https://randomuser.me/api/portraits/men/2.jpg" alt="PlayerTwo"> <a class="user-link" href="user.html?user=170327552525729793">PlayerTwo</a> <span class="score">8,500 pts</span></li>
          <li><span class="rank">3</span> <img class="avatar" src="https://randomuser.me/api/portraits/men/3.jpg" alt="PlayerThree"> <a class="user-link" href="user.html?user=170327552525729794">PlayerThree</a> <span class="score">8,000 pts</span></li>
          <li><span class="rank">4</span> <img class="avatar" src="https://randomuser.me/api/portraits/men/4.jpg" alt="PlayerFour"> <a class="user-link" href="user.html?user=170327552525729795">PlayerFour</a> <span class="score">7,800 pts</span></li>
          <li><span class="rank">5</span> <img class="avatar" src="https://randomuser.me/api/portraits/men/5.jpg" alt="PlayerFive"> <a class="user-link" href="user.html?user=170327552525729796">PlayerFive</a> <span class="score">7,700 pts</span></li>
        </ol>
      </div>
    </section>
    <section class="most-popular card">
      <h2><i class="fas fa-fire"></i> Most Popular</h2>
      <div class="popular-tabs">
        <button class="tab-btn active" data-tab="popular-weekly">Weekly</button>
        <button class="tab-btn" data-tab="popular-monthly">Monthly</button>
        <button class="tab-btn" data-tab="popular-alltime">All-Time</button>
      </div>
      <div class="tab-content" id="popular-weekly">
        <ol class="popular-games-list">
          <li><span class="rank">1</span> <img class="game-cover-sm" src="https://static-cdn.jtvnw.net/ttv-boxart/27471-144x192.jpg" alt="Stardew Valley"> <a class="game-link" href="game.html?game=StardewValley">Stardew Valley</a> <span class="hours">80 hrs</span></li>
          <li><span class="rank">2</span> <img class="game-cover-sm" src="https://static-cdn.jtvnw.net/ttv-boxart/516575-144x192.jpg" alt="Elden Ring"> <a class="game-link" href="game.html?game=EldenRing">Elden Ring</a> <span class="hours">75 hrs</span></li>
          <li><span class="rank">3</span> <img class="game-cover-sm" src="https://static-cdn.jtvnw.net/ttv-boxart/2748-144x192.jpg" alt="Minecraft"> <a class="game-link" href="game.html?game=Minecraft">Minecraft</a> <span class="hours">60 hrs</span></li>
          <li><span class="rank">4</span> <img class="game-cover-sm" src="https://static-cdn.jtvnw.net/ttv-boxart/33214-144x192.jpg" alt="DOOM"> <a class="game-link" href="game.html?game=DOOM">DOOM</a> <span class="hours">55 hrs</span></li>
          <li><span class="rank">5</span> <img class="game-cover-sm" src="https://static-cdn.jtvnw.net/ttv-boxart/493057-144x192.jpg" alt="Portal"> <a class="game-link" href="game.html?game=Portal">Portal</a> <span class="hours">50 hrs</span></li>
        </ol>
      </div>
      <div class="tab-content" id="popular-monthly" style="display:none;">
        <ol class="popular-games-list">
          <li><span class="rank">1</span> <img class="game-cover-sm" src="https://static-cdn.jtvnw.net/ttv-boxart/516575-144x192.jpg" alt="Elden Ring"> <a class="game-link" href="game.html?game=EldenRing">Elden Ring</a> <span class="hours">320 hrs</span></li>
          <li><span class="rank">2</span> <img class="game-cover-sm" src="https://static-cdn.jtvnw.net/ttv-boxart/27471-144x192.jpg" alt="Stardew Valley"> <a class="game-link" href="game.html?game=StardewValley">Stardew Valley</a> <span class="hours">290 hrs</span></li>
          <li><span class="rank">3</span> <img class="game-cover-sm" src="https://static-cdn.jtvnw.net/ttv-boxart/2748-144x192.jpg" alt="Minecraft"> <a class="game-link" href="game.html?game=Minecraft">Minecraft</a> <span class="hours">250 hrs</span></li>
          <li><span class="rank">4</span> <img class="game-cover-sm" src="https://static-cdn.jtvnw.net/ttv-boxart/33214-144x192.jpg" alt="DOOM"> <a class="game-link" href="game.html?game=DOOM">DOOM</a> <span class="hours">200 hrs</span></li>
          <li><span class="rank">5</span> <img class="game-cover-sm" src="https://static-cdn.jtvnw.net/ttv-boxart/493057-144x192.jpg" alt="Portal"> <a class="game-link" href="game.html?game=Portal">Portal</a> <span class="hours">180 hrs</span></li>
        </ol>
      </div>
      <div class="tab-content" id="popular-alltime" style="display:none;">
        <ol class="popular-games-list">
          <li><span class="rank">1</span> <img class="game-cover-sm" src="https://static-cdn.jtvnw.net/ttv-boxart/2748-144x192.jpg" alt="Minecraft"> <a class="game-link" href="game.html?game=Minecraft">Minecraft</a> <span class="hours">5,000 hrs</span></li>
          <li><span class="rank">2</span> <img class="game-cover-sm" src="https://static-cdn.jtvnw.net/ttv-boxart/516575-144x192.jpg" alt="Elden Ring"> <a class="game-link" href="game.html?game=EldenRing">Elden Ring</a> <span class="hours">4,200 hrs</span></li>
          <li><span class="rank">3</span> <img class="game-cover-sm" src="https://static-cdn.jtvnw.net/ttv-boxart/27471-144x192.jpg" alt="Stardew Valley"> <a class="game-link" href="game.html?game=StardewValley">Stardew Valley</a> <span class="hours">4,100 hrs</span></li>
          <li><span class="rank">4</span> <img class="game-cover-sm" src="https://static-cdn.jtvnw.net/ttv-boxart/33214-144x192.jpg" alt="DOOM"> <a class="game-link" href="game.html?game=DOOM">DOOM</a> <span class="hours">3,900 hrs</span></li>
          <li><span class="rank">5</span> <img class="game-cover-sm" src="https://static-cdn.jtvnw.net/ttv-boxart/493057-144x192.jpg" alt="Portal"> <a class="game-link" href="game.html?game=Portal">Portal</a> <span class="hours">3,500 hrs</span></li>
        </ol>
      </div>
    </section>
    <section class="log-game card">
      <h2><i class="fas fa-gamepad"></i> Log Game Session</h2>
      <form id="log-game-form">
        <div class="form-row">
          <div class="form-group game-name-group">
            <label for="game-name">
              <i class="fas fa-gamepad"></i>
              Manual Entry
            </label>
            <div class="search-container">
              <input type="text" id="game-name" placeholder="Enter game name..." required>
              <div class="autocomplete-dropdown"></div>
            </div>
          </div>
          <div class="form-group hours-group">
            <label for="hours">
              <i class="fas fa-clock"></i>
              Hours
            </label>
            <input type="number" id="hours" placeholder="Hours..." step="0.5" min="0.5" required>
          </div>
          <button type="submit" class="submit-button">
            <i class="fas fa-plus"></i>
            Log
          </button>
        </div>
      </form>
      <div class="timer-divider">
        <span>OR</span>
      </div>
      <div class="timer-section">
        <div class="timer-input">
          <div class="form-group">
            <label for="timer-game-name">
              <i class="fas fa-gamepad"></i>
              Session Timer
            </label>
            <div class="search-container">
              <input type="text" id="timer-game-name" placeholder="Search for a game..." autocomplete="off">
            </div>
          </div>
          <div class="timer-controls">
            <button id="start-timer" class="timer-button" disabled>START TIMER</button>
            <button id="stop-timer" class="timer-button" disabled style="display: none;">STOP</button>
          </div>
        </div>
        <div class="timer-display" style="display: none;">
          <div class="timer-box-art">
            <img src="https://static-cdn.jtvnw.net/ttv-boxart/loading_boxart.png" alt="Game Box Art" id="timer-box-art">
          </div>
          <div class="timer-time">
            <span id="timer-hours">00</span>:<span id="timer-minutes">00</span>:<span id="timer-seconds">00</span>
          </div>
          <div class="timer-active-controls">
            <button id="pause-timer" class="timer-button">PAUSE</button>
            <button id="resume-timer" class="timer-button" style="display: none;">RESUME</button>
            <button id="log-timer" class="timer-button">LOG SESSION</button>
          </div>
        </div>
      </div>
      <div class="sign-in-message">
        <i class="fab fa-discord"></i>
        Please sign in to use
      </div>
    </section>
    <section class="activity card activity-wide">
      <h2><i class="fas fa-gamepad"></i> Recent Activity</h2>
      <button class="carousel-arrow left" aria-label="Scroll left"><i class="fas fa-chevron-left"></i></button>
      <div class="activity-carousel">
        <div class="loading-spinner">
          <i class="fas fa-spinner fa-spin"></i> Loading recent activity...
        </div>
      </div>
      <button class="carousel-arrow right" aria-label="Scroll right"><i class="fas fa-chevron-right"></i></button>
    </section>
    <section class="bonuses card bonuses-bottom">
      <h2><i class="fas fa-gift"></i> Recent Bonuses</h2>
      <div class="loading-spinner">
        <i class="fas fa-spinner fa-spin"></i> Loading recent bonuses...
      </div>
    </section>
  </main>
  <footer>
    <p>Inspired by backloggd & letterboxd. Not affiliated with Discord.</p>
  </footer>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Check authentication status
      fetch('/api/user')
        .then(response => {
          if (response.ok) {
            return response.json();
          }
          throw new Error('Not authenticated');
        })
        .then(user => {
          const authContainer = document.getElementById('auth-container');
          authContainer.innerHTML = `
            <a href="/user.html?user=${user.id}" class="user-profile">
              <img src="${user.avatar ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png` : 'https://cdn.discordapp.com/embed/avatars/0.png'}" 
                   alt="${user.username}" 
                   class="user-avatar">
              <span class="user-name">${user.username}</span>
            </a>
            <a href="/logout" class="logout-button" title="Logout">
              <i class="fas fa-sign-out-alt"></i>
            </a>
          `;
        })
        .catch(() => {
          // User is not authenticated, keep the login button
          const authContainer = document.getElementById('auth-container');
          authContainer.innerHTML = `
            <a href="/login" class="auth-button login-button">
              <i class="fab fa-discord"></i>
              Login with Discord
            </a>
          `;
        });

      // Existing tab switching logic
      const tabContainers = document.querySelectorAll('.leaderboard-tabs, .popular-tabs');

      tabContainers.forEach(container => {
          const tabButtons = container.querySelectorAll('.tab-btn');
          // Find the content container for this set of tabs
          const contentContainer = container.nextElementSibling; // Assuming content immediately follows the buttons

          tabButtons.forEach(button => {
              button.addEventListener('click', function() {
                  const tabId = this.getAttribute('data-tab');
                  const parentSection = this.closest('section'); // Get the parent section

                  // Determine which section this tab belongs to and fetch data accordingly
                  if (parentSection.classList.contains('leaderboard')) {
                      // Leaderboard tabs
                      const timeframe = tabId; // Tab ID is the timeframe directly (weekly, monthly, alltime)
                       // Deactivate all buttons in this container
                      container.querySelectorAll('.tab-btn').forEach(btn => {
                          btn.classList.remove('active');
                      });
                       // Activate the clicked button
                      this.classList.add('active');

                       // Hide all content divs in this section and show the selected one
                       parentSection.querySelectorAll('.tab-content').forEach(content => {
                           content.style.display = 'none';
                       });
                       document.getElementById(tabId).style.display = 'block';

                       fetchLeaderboardData(timeframe); // Fetch data on click

                  } else if (parentSection.classList.contains('most-popular')) {
                      // Most Popular tabs
                      // Extract timeframe from tab ID (e.g., 'popular-weekly' -> 'weekly')
                      const timeframe = tabId.replace('popular-', '');

                       // Deactivate all buttons in this container
                      container.querySelectorAll('.tab-btn').forEach(btn => {
                          btn.classList.remove('active');
                      });
                       // Activate the clicked button
                      this.classList.add('active');

                       // Hide all content divs in this section and show the selected one
                       parentSection.querySelectorAll('.tab-content').forEach(content => {
                           content.style.display = 'none';
                       });
                       document.getElementById(tabId).style.display = 'block';

                       fetchPopularGames(timeframe); // Fetch data on click
                  }
              });
          });
      });

      // Initial display of active tabs
       document.querySelectorAll('.tab-content').forEach(content => {
           content.style.display = 'none';
       });
      document.querySelectorAll('.tab-btn.active').forEach(activeButton => {
          const tabId = activeButton.getAttribute('data-tab');
          const tabContent = document.getElementById(tabId);
          if (tabContent) {
              tabContent.style.display = 'block';
              // Trigger initial fetch for the active tabs
              if (activeButton.closest('.leaderboard-tabs')) {
                  fetchLeaderboardData(tabId);
              } else if (activeButton.closest('.popular-tabs')) {
                  // Extract timeframe from popular tab ID (e.g., 'popular-weekly' -> 'weekly')
                  const timeframe = tabId.replace('popular-', '');
                  fetchPopularGames(timeframe);
              }
          }
      });

      // Function to fetch and display leaderboard data for a specific timeframe
      // Helper function to format numbers with commas
      function formatNumberWithCommas(number) {
         return number.toLocaleString();
      }

      // Function to show loading state
      function setLoadingState(element, isLoading) {
        if (isLoading) {
          element.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
        }
      }

      // Function to create loading placeholders
      function createLoadingPlaceholders(count) {
        const placeholders = [];
        for (let i = 0; i < count; i++) {
          const placeholder = document.createElement('li');
          placeholder.className = 'loading-placeholder';
          placeholder.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Loading...`;
          placeholders.push(placeholder);
        }
        return placeholders;
      }

      function fetchPopularGames(timeframe) {
        const popularList = document.querySelector(`#popular-${timeframe} ol`);
        if (!popularList) return;

        // Try to show cached data instantly
        const cacheKey = `popular_${timeframe}`;
        const cached = localStorage.getItem(cacheKey);
        if (cached) {
          try {
            const data = JSON.parse(cached);
            popularList.innerHTML = '';
            if (data && data.length > 0) {
              data.forEach((game, index) => {
                const listItem = document.createElement('li');
                
                let mediaElement;
                if (game.box_art_url && game.box_art_url.endsWith('.webm')) {
                    mediaElement = document.createElement('video');
                    mediaElement.src = game.box_art_url;
                    mediaElement.autoplay = true;
                    mediaElement.loop = true;
                    mediaElement.muted = true;
                    mediaElement.playsInline = true;
                } else {
                    mediaElement = document.createElement('img');
                    mediaElement.src = game.box_art_url || 'https://static-cdn.jtvnw.net/ttv-boxart/loading_boxart.png';
                    mediaElement.onerror = function() {
                        this.src = 'https://static-cdn.jtvnw.net/ttv-boxart/loading_boxart.png';
                    };
                }
                mediaElement.className = 'game-cover-sm';
                mediaElement.alt = game.name;

                listItem.innerHTML = `
                  <span class="rank">${index + 1}</span>
                  <div class="popular-game-row">
                    <a class="game-link" href="game.html?game=${encodeURIComponent(game.name)}">${game.name}</a>
                    <span class="hours">${formatNumberWithCommas(game.total_hours || 0)} hrs</span>
                  </div>
                `;
                
                listItem.insertBefore(mediaElement, listItem.firstChild);
                popularList.appendChild(listItem);
              });
            } else {
              popularList.innerHTML = '<li>No game data available.</li>';
            }
          } catch (e) {}
        } else {
          // Show loading state if no cache
          popularList.innerHTML = '';
          const loadingPlaceholders = createLoadingPlaceholders(5);
          loadingPlaceholders.forEach(placeholder => popularList.appendChild(placeholder));
        }

        // Always fetch fresh data in the background
        fetch(`/api/popular-games?timeframe=${timeframe}`)
          .then(response => response.json())
          .then(data => {
            popularList.innerHTML = '';
            if (data && data.length > 0) {
              data.forEach((game, index) => {
                const listItem = document.createElement('li');
                
                let mediaElement;
                if (game.box_art_url && game.box_art_url.endsWith('.webm')) {
                    mediaElement = document.createElement('video');
                    mediaElement.src = game.box_art_url;
                    mediaElement.autoplay = true;
                    mediaElement.loop = true;
                    mediaElement.muted = true;
                    mediaElement.playsInline = true;
                } else {
                    mediaElement = document.createElement('img');
                    mediaElement.src = game.box_art_url || 'https://static-cdn.jtvnw.net/ttv-boxart/loading_boxart.png';
                    mediaElement.onerror = function() {
                        this.src = 'https://static-cdn.jtvnw.net/ttv-boxart/loading_boxart.png';
                    };
                }
                mediaElement.className = 'game-cover-sm';
                mediaElement.alt = game.name;

                listItem.innerHTML = `
                  <span class="rank">${index + 1}</span>
                  <div class="popular-game-row">
                    <a class="game-link" href="game.html?game=${encodeURIComponent(game.name)}">${game.name}</a>
                    <span class="hours">${formatNumberWithCommas(game.total_hours || 0)} hrs</span>
                  </div>
                `;
                
                listItem.insertBefore(mediaElement, listItem.firstChild);
                popularList.appendChild(listItem);
              });
              localStorage.setItem(cacheKey, JSON.stringify(data));
            } else {
              popularList.innerHTML = '<li>No game data available.</li>';
              localStorage.removeItem(cacheKey);
            }
          })
          .catch(error => {
            console.error(`Error fetching ${timeframe} popular games data:`, error);
            popularList.innerHTML = '<li>Error loading game data.</li>';
          });
      }

      function fetchLeaderboardData(timeframe) {
        const leaderboardList = document.querySelector(`#${timeframe} ol`);
        if (!leaderboardList) return;

        // Try to show cached data instantly
        const cacheKey = `leaderboard_${timeframe}`;
        const cached = localStorage.getItem(cacheKey);
        if (cached) {
          try {
            const data = JSON.parse(cached);
            leaderboardList.innerHTML = '';
            if (data && data.length > 0) {
              data.slice(0, 5).forEach((player, index) => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `
                  <span class="rank">${index + 1}</span>
                  <img class="avatar" src="${player.avatar_url || 'https://www.gravatar.com/avatar/?d=mp&s=50'}" alt="${player.username}">
                  <a class="user-link" href="user.html?user=${player.user_id}">${player.username}</a>
                  <span class="score">${formatNumberWithCommas(player.total_credits || 0)} pts</span>
                `;
                leaderboardList.appendChild(listItem);
              });
            } else {
              leaderboardList.innerHTML = '<li>No leaderboard data available.</li>';
            }
          } catch (e) {}
        } else {
          // Show loading state if no cache
          leaderboardList.innerHTML = '';
          const loadingPlaceholders = createLoadingPlaceholders(5);
          loadingPlaceholders.forEach(placeholder => leaderboardList.appendChild(placeholder));
        }

        // Always fetch fresh data in the background
        fetch(`/api/leaderboard?timeframe=${timeframe}`)
          .then(response => response.json())
          .then(data => {
            leaderboardList.innerHTML = '';
            if (data && data.length > 0) {
              data.slice(0, 5).forEach((player, index) => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `
                  <span class="rank">${index + 1}</span>
                  <img class="avatar" src="${player.avatar_url || 'https://www.gravatar.com/avatar/?d=mp&s=50'}" alt="${player.username}">
                  <a class="user-link" href="user.html?user=${player.user_id}">${player.username}</a>
                  <span class="score">${formatNumberWithCommas(player.total_credits || 0)} pts</span>
                `;
                leaderboardList.appendChild(listItem);
              });
              localStorage.setItem(cacheKey, JSON.stringify(data));
            } else {
              leaderboardList.innerHTML = '<li>No leaderboard data available.</li>';
              localStorage.removeItem(cacheKey);
            }
          })
          .catch(error => {
            console.error(`Error fetching ${timeframe} leaderboard data:`, error);
            leaderboardList.innerHTML = '<li>Error loading leaderboard data.</li>';
          });
      }

      // Fetch data for all timeframes on page load
      fetchLeaderboardData('weekly');
      fetchLeaderboardData('monthly');
      fetchLeaderboardData('alltime');
      fetchPopularGames('weekly');
      fetchPopularGames('monthly');
      fetchPopularGames('alltime');

    });

    // --- Recent Activity with localStorage cache ---
    async function fetchRecentActivity() {
      const activityCarousel = document.querySelector('.activity-carousel');
      if (!activityCarousel) return;

      // Try to show cached data instantly
      const cacheKey = 'recent_activity';
      const cached = localStorage.getItem(cacheKey);
      if (cached) {
        try {
          const recentActivity = JSON.parse(cached);
          renderRecentActivity(recentActivity);
        } catch (e) {}
      } else {
        // Show loading state if no cache
        activityCarousel.innerHTML = '';
        for (let i = 0; i < 5; i++) {
          const loadingCard = document.createElement('div');
          loadingCard.className = 'activity-card-wrap';
          loadingCard.innerHTML = `
            <div class="activity-card loading">
              <div class="activity-overlay loading">
                <div class="activity-userblock">
                  <span class="activity-sessions">Loading...</span>
                  <span class="activity-time">Loading...</span>
                </div>
              </div>
            </div>
          `;
          activityCarousel.appendChild(loadingCard);
        }
      }

      // Always fetch fresh data in the background
      try {
        const response = await fetch('/api/recent-activity');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const recentActivity = await response.json();
        renderRecentActivity(recentActivity);
        localStorage.setItem(cacheKey, JSON.stringify(recentActivity));
      } catch (error) {
        console.error('Error fetching recent activity:', error);
        activityCarousel.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Error loading activity</div>';
      }
    }

    function renderRecentActivity(recentActivity) {
      const activityCarousel = document.querySelector('.activity-carousel');
      if (!activityCarousel) return;
      activityCarousel.innerHTML = '';
      if (!recentActivity || recentActivity.length === 0) {
        activityCarousel.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> No recent activity found</div>';
        return;
      }
      recentActivity.forEach(session => {
        const cardWrap = document.createElement('div');
        cardWrap.className = 'activity-card-wrap';
        const timestamp = new Date(session.timestamp);
        
        let mediaElement;
        if (session.box_art_url && session.box_art_url.endsWith('.webm')) {
            mediaElement = document.createElement('video');
            mediaElement.src = session.box_art_url;
            mediaElement.autoplay = true;
            mediaElement.loop = true;
            mediaElement.muted = true;
            mediaElement.playsInline = true;
        } else {
            mediaElement = document.createElement('img');
            mediaElement.src = session.box_art_url || 'https://static-cdn.jtvnw.net/ttv-boxart/loading_boxart.png';
            mediaElement.onerror = function() {
                this.src = 'https://static-cdn.jtvnw.net/ttv-boxart/loading_boxart.png';
            };
        }
        mediaElement.className = 'game-cover-carousel';
        mediaElement.alt = session.game_name;

        cardWrap.innerHTML = `
          <div class="activity-card">
            <a href="game.html?game=${encodeURIComponent(session.game_name)}">
            </a>
            <div class="activity-date">${timestamp.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
            <div class="activity-overlay">
              <img class="activity-avatar" src="${session.avatar_url}" alt="${session.username}">
              <div class="activity-userblock">
                <span class="activity-player"><a class="user-link" href="user.html?user=${session.user_id}">${session.username}</a></span>
                <span class="activity-hours">${formatHours(session.hours)}</span>
              </div>
            </div>
          </div>
        `;
        
        const link = cardWrap.querySelector('a');
        link.insertBefore(mediaElement, link.firstChild);
        activityCarousel.appendChild(cardWrap);
      });
    }

    // --- Most Popular Games with localStorage cache ---
    function fetchPopularGames(timeframe) {
      const popularList = document.querySelector(`#popular-${timeframe} ol`);
      if (!popularList) return;

      // Try to show cached data instantly
      const cacheKey = `popular_${timeframe}`;
      const cached = localStorage.getItem(cacheKey);
      if (cached) {
        try {
          const data = JSON.parse(cached);
          popularList.innerHTML = '';
          if (data && data.length > 0) {
            data.forEach((game, index) => {
              const listItem = document.createElement('li');
              
              let mediaElement;
              if (game.box_art_url && game.box_art_url.endsWith('.webm')) {
                  mediaElement = document.createElement('video');
                  mediaElement.src = game.box_art_url;
                  mediaElement.autoplay = true;
                  mediaElement.loop = true;
                  mediaElement.muted = true;
                  mediaElement.playsInline = true;
              } else {
                  mediaElement = document.createElement('img');
                  mediaElement.src = game.box_art_url || 'https://static-cdn.jtvnw.net/ttv-boxart/loading_boxart.png';
                  mediaElement.onerror = function() {
                      this.src = 'https://static-cdn.jtvnw.net/ttv-boxart/loading_boxart.png';
                  };
              }
              mediaElement.className = 'game-cover-sm';
              mediaElement.alt = game.name;

              listItem.innerHTML = `
                <span class="rank">${index + 1}</span>
                <div class="popular-game-row">
                  <a class="game-link" href="game.html?game=${encodeURIComponent(game.name)}">${game.name}</a>
                  <span class="hours">${formatNumberWithCommas(game.total_hours || 0)} hrs</span>
                </div>
              `;
              
              listItem.insertBefore(mediaElement, listItem.firstChild);
              popularList.appendChild(listItem);
            });
          } else {
            popularList.innerHTML = '<li>No game data available.</li>';
          }
        } catch (e) {}
      } else {
        // Show loading state if no cache
        popularList.innerHTML = '';
        const loadingPlaceholders = createLoadingPlaceholders(5);
        loadingPlaceholders.forEach(placeholder => popularList.appendChild(placeholder));
      }

      // Always fetch fresh data in the background
      fetch(`/api/popular-games?timeframe=${timeframe}`)
        .then(response => response.json())
        .then(data => {
          popularList.innerHTML = '';
          if (data && data.length > 0) {
            data.forEach((game, index) => {
              const listItem = document.createElement('li');
              
              let mediaElement;
              if (game.box_art_url && game.box_art_url.endsWith('.webm')) {
                  mediaElement = document.createElement('video');
                  mediaElement.src = game.box_art_url;
                  mediaElement.autoplay = true;
                  mediaElement.loop = true;
                  mediaElement.muted = true;
                  mediaElement.playsInline = true;
              } else {
                  mediaElement = document.createElement('img');
                  mediaElement.src = game.box_art_url || 'https://static-cdn.jtvnw.net/ttv-boxart/loading_boxart.png';
                  mediaElement.onerror = function() {
                      this.src = 'https://static-cdn.jtvnw.net/ttv-boxart/loading_boxart.png';
                  };
              }
              mediaElement.className = 'game-cover-sm';
              mediaElement.alt = game.name;

              listItem.innerHTML = `
                <span class="rank">${index + 1}</span>
                <div class="popular-game-row">
                  <a class="game-link" href="game.html?game=${encodeURIComponent(game.name)}">${game.name}</a>
                  <span class="hours">${formatNumberWithCommas(game.total_hours || 0)} hrs</span>
                </div>
              `;
              
              listItem.insertBefore(mediaElement, listItem.firstChild);
              popularList.appendChild(listItem);
            });
            localStorage.setItem(cacheKey, JSON.stringify(data));
          } else {
            popularList.innerHTML = '<li>No game data available.</li>';
            localStorage.removeItem(cacheKey);
          }
        })
        .catch(error => {
          console.error(`Error fetching ${timeframe} popular games data:`, error);
          popularList.innerHTML = '<li>Error loading game data.</li>';
        });
    }

    // Replace the original fetchRecentActivity with the new one
    fetchRecentActivity();

    // Function to detect if user is on mobile
    function isMobileDevice() {
      return (
        /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
        (window.innerWidth <= 768 && window.innerHeight <= 1024)
      );
    }

    // Function to handle mobile-specific elements
    function handleMobileElements() {
      const mobileElements = document.querySelectorAll('.mobile-only');
      const desktopElements = document.querySelectorAll('.desktop-only');
      
      if (isMobileDevice()) {
        mobileElements.forEach(el => el.style.display = 'block');
        desktopElements.forEach(el => el.style.display = 'none');
      } else {
        mobileElements.forEach(el => el.style.display = 'none');
        desktopElements.forEach(el => el.style.display = 'block');
      }
    }

    // Run on page load
    handleMobileElements();

    // Run on window resize
    window.addEventListener('resize', handleMobileElements);

    // Mobile menu toggle
    const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
    const navCenter = document.querySelector('.nav-center');
    let isMenuOpen = false;

    mobileMenuToggle.addEventListener('click', function(e) {
      e.stopPropagation();
      isMenuOpen = !isMenuOpen;
      navCenter.classList.toggle('active');
      
      // Update hamburger icon
      const icon = this.querySelector('i');
      if (isMenuOpen) {
        icon.classList.remove('fa-bars');
        icon.classList.add('fa-times');
      } else {
        icon.classList.remove('fa-times');
        icon.classList.add('fa-bars');
      }
    });

    // Close mobile menu when clicking outside
    document.addEventListener('click', function(event) {
      if (isMenuOpen && !navCenter.contains(event.target) && !mobileMenuToggle.contains(event.target)) {
        isMenuOpen = false;
        navCenter.classList.remove('active');
        const icon = mobileMenuToggle.querySelector('i');
        icon.classList.remove('fa-times');
        icon.classList.add('fa-bars');
      }
    });

    // Prevent clicks inside the menu from closing it
    navCenter.addEventListener('click', function(event) {
      event.stopPropagation();
    });

    // Add this helper function near the other formatting functions
    function formatHours(hours) {
      const wholeHours = Math.floor(hours);
      const minutes = Math.round((hours - wholeHours) * 60);
      let timeDisplay = '';
      if (wholeHours > 0) {
        timeDisplay += `${wholeHours}h `;
      }
      if (minutes > 0 || wholeHours === 0) {
        timeDisplay += `${minutes}m`;
      }
      return timeDisplay;
    }

    // Function to set up the activity carousel scrolling
    function setupActivityCarousel() {
      const activityCarousel = document.querySelector('.activity-carousel');
      const leftArrow = document.querySelector('.activity-wide .carousel-arrow.left');
      const rightArrow = document.querySelector('.activity-wide .carousel-arrow.right');

      if (!activityCarousel || !leftArrow || !rightArrow) {
        console.error('Activity carousel elements not found for scrolling setup.');
        return;
      }

      const scrollAmount = 300; // Adjust scroll amount as needed

      leftArrow.addEventListener('click', () => {
        activityCarousel.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
      });

      rightArrow.addEventListener('click', () => {
        activityCarousel.scrollBy({ left: scrollAmount, behavior: 'smooth' });
      });
    }

    // Call setupActivityCarousel after fetching recent activity
    fetchRecentActivity().then(() => setupActivityCarousel());
    
  </script>
</body>
<script src="script.js"></script>
</html> 